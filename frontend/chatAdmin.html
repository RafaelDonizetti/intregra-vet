<!DOCTYPE html>
<html lang="pt-bt">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="assets/css/chat-admin.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat | IntegraVet</title>
    <script src="./assets/js/chatmodal.js"></script>
    <script src="./assets/js/cliente.js"></script>
  </head>
  <body>
    <h2 id="room-name"></h2>
    <aside class="contatos" id="users">
    </aside>

    <section class="section_chat">
      <header class="chat_header">
        <nav>
          <div class="info__user">
            <a href="/"><img src="./assets/img/back-arrow.svg" alt="" /></a>
            <span class="user_foto">
              <img src="/" alt="" id="profileImageAdm">
            </span>
            <span id="nome"></span>
          </div>
            <button id="btnDelete"></button>
            <div id="deleteModal" class="modal">
              <p>Tem certeza de que deseja excluir?</p>
              <button id="confirmDelete" class="modal-btn">Sim</button>
              <button id="cancelDelete" class="modal-btn" onclick="closeModal()">Cancelar</button>
            </div>
            <div id="modalOverlay" class="overlay"></div>
        </nav>
      </header>
      <!-- Área do chat -->
      <div class="chat_area">
        <!-- Div para as mensagens -->
        <div class="messagesDiv" id="seguraMensagens"></div>
        <!-- Formulário de entrada de mensagem -->
        <form class="input_field" id="chat-form">
          <input type="text" name="message" id="msg" placeholder="Mensagem" />
          <button type="submit">
            <img src="./assets/img/send-arrow.svg" alt="" />
          </button>
        </form>
      </div>
    </section>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const userList = document.getElementById('users')
      const roomName = document.getElementById('room-name')
      
      function scrollParaBaixo() {
        const messagesDiv = document.getElementById("seguraMensagens");
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
      const textMessage = document.getElementById("chat-form");
      const socket = io.connect("http://localhost:3000/");
      const btnDelete = document.getElementById("confirmDelete")


      socket.emit("joinRoom");

      btnDelete.addEventListener("click", function(){
        if (roomT) {
        socket.emit("deleteHistory", roomT)
        document.getElementById("seguraMensagens").innerHTML = "";
        }
      })

      socket.on("roomUsers", ({ users, room }) => {
        contatosFrontEnd(users, room)
      })
      
      socket.on("chatHistory", (historico) => {
        mensagemFrontEndHistorico(historico)
      })

      // Pega a mensagem do servidor
      socket.on("mensagem", (mensagem) => {
        mensagemFrontEnd(mensagem);
      });

      // Envia a mensagem
      textMessage.addEventListener("submit", (e) => {
        e.preventDefault();

        //Pega o Texto Escrito pelo Usuario
        const msg = e.target.elements.msg.value.trim();

        if (msg !== "") {
          //Envia uma mensagem pro servidor
          socket.emit("chatMessage", msg);

          //Limpa a barra de escrever mensagem dps de enviar
          e.target.elements.msg.value = "";
          e.target.elements.msg.focus();
        }
      });
      
      //Da output da mensagem para o frontend
      function contatosFrontEnd(users, room) {
        userList.innerHTML = `
          ${users.map((user, index) => `<div class="contato1" data-room="${room[index]}"><h1>${user}</h1><span></span></div>`).join('')}
        `;
      
        // Adiciona um evento de clique a cada elemento de usuário
        users.forEach((user, index) => {
          const userElement = document.querySelector(`.contato1:nth-child(${index + 1})`);
          if (userElement) {
            userElement.addEventListener('click', () => handleUserClick(user, room[index]));
          }
        });
      }
      let roomT
      // Função para lidar com o clique do usuário
      function handleUserClick(userName, roomValue) {
        socket.emit("roomClick", userName, roomValue)
        roomT = roomValue
        // Faça o que for necessário com o nome do usuário aqui
        // Por exemplo, você pode emitir um evento para o servidor, abrir uma janela, etc.
      }

      function mensagemFrontEnd(mensagem) {
        const div = document.createElement("div");
        div.classList.add("mensagem");
        div.innerHTML = `
        <div class="messages">
            <p class = "messages_time">${mensagem.time}</p>
            <div class="infoMessages">
                <p class = "user_message">${mensagem.nome}</p>
                <p class="boxMesseges">${mensagem.text}</p>
            </div>
        </div>`;
        document.getElementById("seguraMensagens").appendChild(div);

        scrollParaBaixo();
      }

      function formatarHoraParaAMPM(data) {
        const options = { timeZone: 'America/Sao_Paulo', hour12: true, hour: 'numeric', minute: 'numeric', second: 'numeric' };
        const formattedDate = data.toLocaleString('en-US', options);
      
        return formattedDate;
      }
      
      // Restante do código...
      
      function mensagemFrontEndHistorico(historico) {
        const container = document.getElementById("seguraMensagens");
        container.innerHTML = "";
      
        historico.forEach((mensagem) => {
          const div = document.createElement("div");
          div.classList.add("mensagem");
      
          let senderName = mensagem.sender_name || "Desconhecido";
          let mensagemText = mensagem.mensagem || "";
          let sendDate = mensagem.send_date ? new Date(mensagem.send_date) : new Date();
      
          const formattedSendDate = formatarHoraParaAMPM(sendDate);
          div.innerHTML = `
            <div class="messages">
              <p class="messages_time">${formattedSendDate}</p>
              <div class="infoMessages">
                <p class="user_message">${senderName}</p>
                <p class="boxMesseges">${mensagemText}</p>
              </div>
            </div>
          `;
      
          container.appendChild(div);
        });
      
        scrollParaBaixo();
      }

    </script>
  </body>
</html>
